<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milli for Inbound</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="defalt">
    <link rel="icon" href="./favicon.ico">
    <link rel="apple-touch-icon" href="./logo.png">
    <link rel="manifest" href="./manifest.json">
    
    <!-- Tailwind CSS (Design) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (Framework) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (JSX Compiler) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Custom scrollbar for tabs/lists */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 3px;
        }
        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            background-color: #f8fafc; /* slate-50 */
            color: #1e293b; /* slate-800 */
        }
        /* Fade in animation for tooltip */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-4px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.15s ease-out forwards;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Icon Components (Inline SVG for Zero Dependencies) ---
        const Icon = ({ path, size = 18, className = "" }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
            >
                {path}
            </svg>
        );

        const icons = {
            arrowLeft: <path d="M19 12H5M12 19l-7-7 7-7"/>,
            users: <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2M9 10a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/>,
            star: <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>,
            globe: <React.Fragment><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></React.Fragment>,
            mapPin: <React.Fragment><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></React.Fragment>,
            flag: <React.Fragment><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></React.Fragment>,
            train: <React.Fragment><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/><path d="M2 8h20"/></React.Fragment>,
            wallet: <React.Fragment><path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4"/><path d="M4 6v12c0 1.1.9 2 2 2h14v-4"/><path d="M18 12a2 2 0 0 0-2 2c0 1.1.9 2 2 2h4v-4h-4z"/></React.Fragment>,
            messageSquare: <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>,
            thumbsUp: <React.Fragment><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/></React.Fragment>,
            heart: <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>,
            alertCircle: <React.Fragment><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></React.Fragment>,
            loader: <path d="M21 12a9 9 0 1 1-6.219-2.565"/>
        };

        // --- Logic: CSV Parsing (Robust) ---
        const parseCSV = (text) => {
            // Robust CSV parser that handles newlines inside quotes
            const rows = [];
            let currentRow = [];
            let currentField = '';
            let inQuote = false;
            
            // Normalize line breaks to LF
            const normalizedText = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

            for (let i = 0; i < normalizedText.length; i++) {
                const char = normalizedText[i];
                const nextChar = normalizedText[i + 1];

                if (inQuote) {
                    if (char === '"') {
                        if (nextChar === '"') {
                            // Escaped quote ("") -> literal quote (")
                            currentField += '"';
                            i++; // Skip next quote
                        } else {
                            // End of quote
                            inQuote = false;
                        }
                    } else {
                        currentField += char;
                    }
                } else {
                    if (char === '"') {
                        inQuote = true;
                    } else if (char === ',') {
                        // End of field
                        currentRow.push(currentField);
                        currentField = '';
                    } else if (char === '\n') {
                        // End of row
                        currentRow.push(currentField);
                        if (currentRow.length > 1 || (currentRow.length === 1 && currentRow[0] !== '')) {
                             rows.push(currentRow);
                        }
                        currentRow = [];
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                }
            }
            // Push last field/row if exists
            if (currentField || currentRow.length > 0) {
                currentRow.push(currentField);
                rows.push(currentRow);
            }

            // The first row is the header, data starts from index 1
            if (rows.length < 2) return [];

            return rows.slice(1).map(vals => {
                // Basic validation: ensure we have enough columns
                if (vals.length < 5) return null;

                return {
                    timestamp: vals[0],
                    facility: vals[1],
                    // 3: Satisfaction (Ishikawa)
                    satisfaction: vals[3], 
                    satReason: vals[4],
                    hasInconv: vals[5] === 'Yes',
                    inconvDetail: vals[6],
                    recScore: parseInt(vals[7] || '0', 10),
                    recReason: vals[8],
                    
                    // 9: Japan Status
                    japanStatus: vals[9],
                    gender: vals[10],
                    age: vals[11],
                    country: vals[12],
                    visitCountJapan: vals[13],
                    
                    companion: vals[17],
                    purpose: vals[18],
                    stayDays: vals[19],
                    infoSource: vals[20],
                    travelStyle: vals[21],
                    transportJapan: vals[23],
                    
                    // 26: Expenditure (Remove non-numeric characters like " JPY")
                    expenditure: parseInt((vals[26] || '0').replace(/[^0-9]/g, ''), 10),
                    
                    ishikawaStatus: vals[27],
                    visitCountIshikawa: vals[28],
                    stayNightsIshikawa: vals[29],
                    accommodation: vals[31],
                    destinations: vals[32],
                    experiences: vals[33],
                    events: vals[34],
                    transportIshikawa: vals[35]
                };
            }).filter(item => item !== null && !isNaN(item.recScore));
        };

        // --- UI Components ---
        
        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-slate-200 p-5 ${className}`}>
                {children}
            </div>
        );

        const SectionHeader = ({ title, iconPath }) => (
            <div className="flex items-center gap-2 mb-4 border-b border-slate-100 pb-2">
                <div className="p-1.5 rounded-lg bg-slate-100 text-slate-600">
                    <Icon path={iconPath} />
                </div>
                <h3 className="font-bold text-slate-700 text-lg">{title}</h3>
            </div>
        );

        const ProgressBar = ({ label, value, max, percentage, colorClass, onClickLabel }) => (
            <div className="mb-3 last:mb-0 group relative">
                <div 
                    className={`flex justify-between text-sm mb-1 ${onClickLabel ? 'cursor-pointer hover:opacity-80' : ''}`}
                    onClick={onClickLabel}
                >
                    <span className="font-medium text-slate-600 truncate pr-2 w-3/4 select-none">{label}</span>
                    <div className="flex items-center gap-2 shrink-0">
                        <span className="font-bold text-slate-800">{value}</span>
                        <span className="text-xs text-slate-400 w-8 text-right">{percentage}%</span>
                    </div>
                </div>
                <div className="h-2 w-full bg-slate-100 rounded-full overflow-hidden">
                    <div 
                        className={`h-full rounded-full transition-all duration-500 ease-out ${colorClass}`} 
                        style={{ width: `${percentage}%` }}
                    />
                </div>
            </div>
        );

        const RankingCard = ({ title, data }) => {
            const total = data.reduce((acc, curr) => acc + curr.value, 0);
            const sortedData = [...data].sort((a, b) => b.value - a.value).slice(0, 5);
            const [activeTooltip, setActiveTooltip] = useState(null);

            const getRankColor = (index) => {
                switch (index) {
                    case 0: return "bg-blue-600";
                    case 1: return "bg-blue-500";
                    case 2: return "bg-blue-400";
                    default: return "bg-slate-300";
                }
            };

            const toggleTooltip = (idx) => {
                setActiveTooltip(activeTooltip === idx ? null : idx);
            };

            return (
                <div className="mb-4">
                    <h4 className="text-sm font-semibold text-slate-400 mb-3 uppercase tracking-wider">{title}</h4>
                    {sortedData.map((item, idx) => (
                        <div key={idx} className="relative">
                            <ProgressBar 
                                label={`${idx + 1}. ${item.name}`}
                                value={item.value}
                                max={total}
                                percentage={total > 0 ? Math.round((item.value / total) * 100) : 0}
                                colorClass={getRankColor(idx)}
                                onClickLabel={() => toggleTooltip(idx)}
                            />
                            {/* Tooltip Overlay */}
                            {activeTooltip === idx && (
                                <div 
                                    className="absolute left-0 top-6 z-20 w-full bg-slate-800 text-white text-xs p-3 rounded-lg shadow-xl animate-fade-in cursor-pointer border border-slate-700"
                                    onClick={() => setActiveTooltip(null)}
                                >
                                    <div className="font-bold mb-1 text-slate-300">No.{idx + 1}</div>
                                    <div className="leading-relaxed">{item.name}</div>
                                    <div className="absolute -top-1 left-4 w-2 h-2 bg-slate-800 transform rotate-45 border-l border-t border-slate-700"></div>
                                </div>
                            )}
                        </div>
                    ))}
                    {data.length === 0 && <p className="text-slate-400 text-xs">データなし</p>}
                </div>
            );
        };

        const NPSMeter = ({ nps }) => {
            const percentage = Math.min(Math.max(((nps + 100) / 200) * 100, 0), 100);
            
            let labelColor = "text-slate-700";
            if (nps > 30) labelColor = "text-slate-800";
            else if (nps < 0) labelColor = "text-slate-600";

            return (
                <Card className="h-full flex flex-col items-center justify-center py-6">
                    <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">推奨意向 (NPS)</h4>
                    <div className={`text-5xl font-light mb-1 ${labelColor} font-mono tracking-tighter`}>
                        {nps > 0 ? '+' : ''}{nps}
                    </div>
                    <p className="text-[10px] text-slate-400 mb-4">Score range: -100 to +100</p>
                    
                    <div className="w-full max-w-[80%] h-2 bg-slate-100 rounded-full relative overflow-hidden">
                        <div className="absolute top-0 bottom-0 left-1/2 w-0.5 bg-slate-300 transform -translate-x-1/2 z-0"></div>
                        <div 
                            className="absolute top-0 bottom-0 w-3 h-3 bg-slate-800 rounded-full shadow-md transition-all duration-1000 ease-out z-10 -mt-0.5 border-2 border-white"
                            style={{ left: `calc(${percentage}% - 6px)` }}
                        />
                    </div>
                    <div className="w-full max-w-[80%] flex justify-between text-[10px] text-slate-300 mt-2 font-mono">
                        <span>-100</span>
                        <span>0</span>
                        <span>+100</span>
                    </div>
                </Card>
            );
        };

        // CSS-based Histogram
        const Histogram = ({ data }) => {
            const values = data.map(d => d.expenditure).filter(v => !isNaN(v)).sort((a, b) => a - b);
            const mid = Math.floor(values.length / 2);
            const median = values.length > 0 ? (values.length % 2 !== 0 ? values[mid] : (values[mid - 1] + values[mid]) / 2) : 0;

            const bins = [
                { name: '<5万', max: 50000, count: 0 },
                { name: '5-10万', max: 100000, count: 0 },
                { name: '10-20万', max: 200000, count: 0 },
                { name: '20-30万', max: 300000, count: 0 },
                { name: '30万+', max: Infinity, count: 0 },
            ];

            values.forEach(v => {
                const bin = bins.find(b => v < b.max);
                if (bin) bin.count++;
            });

            const maxCount = Math.max(...bins.map(b => b.count), 1);

            return (
                <Card className="h-full flex flex-col">
                    <div className="flex justify-between items-start mb-6">
                        <h4 className="font-bold text-slate-700">旅行総支出額 (1人あたり)</h4>
                        <div className="text-right">
                            <p className="text-[10px] text-slate-400 uppercase tracking-wider">中央値</p>
                            <p className="text-xl font-bold text-slate-800">¥{median.toLocaleString()}</p>
                        </div>
                    </div>
                    
                    {/* Chart Container */}
                    <div className="w-full h-[200px] flex items-end justify-between gap-2 pt-4 border-b border-slate-100 pb-2">
                        {bins.map((bin, i) => {
                            const heightPct = (bin.count / maxCount) * 100;
                            // Highlight bin containing facility median
                            const isMedianBin = (i === bins.length - 1 && median >= 300000) || 
                                              (median >= (i===0?0:bins[i-1].max) && median < bin.max);
                            
                            return (
                                <div key={i} className="flex flex-col items-center justify-end w-full h-full group relative">
                                    <div className="text-xs text-slate-500 mb-1 opacity-0 group-hover:opacity-100 transition-opacity absolute -top-5">{bin.count}</div>
                                    <div 
                                        className={`w-full rounded-t-sm transition-all duration-500 ${isMedianBin ? 'bg-slate-700' : 'bg-slate-300'}`}
                                        style={{ height: `${heightPct}%` }}
                                    ></div>
                                </div>
                            );
                        })}
                    </div>
                    {/* X Axis Labels */}
                    <div className="flex justify-between gap-2 mt-2">
                        {bins.map((bin, i) => (
                            <div key={i} className="w-full text-center">
                                <span className="text-[9px] sm:text-[10px] text-slate-400 block break-words leading-tight">{bin.name}</span>
                            </div>
                        ))}
                    </div>
                </Card>
            );
        };

        const FeedbackTabs = ({ comments }) => {
            const [activeTab, setActiveTab] = useState('satisfaction');

            const tabs = [
                { id: 'satisfaction', label: '満足理由', iconPath: icons.thumbsUp, color: 'text-slate-700' },
                { id: 'recommend', label: '推奨理由', iconPath: icons.heart, color: 'text-slate-700' },
                { id: 'inconvenience', label: '不満・困りごと', iconPath: icons.alertCircle, color: 'text-slate-700' },
            ];

            const getCount = (id) => {
                if (id === 'satisfaction') return comments.filter(c => c.satReason).length;
                if (id === 'recommend') return comments.filter(c => c.recReason).length;
                if (id === 'inconvenience') return comments.filter(c => c.hasInconv).length;
                return 0;
            };

            return (
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div className="flex border-b border-slate-100">
                        {tabs.map(tab => (
                            <button
                                key={tab.id}
                                onClick={() => setActiveTab(tab.id)}
                                className={`flex-1 py-4 px-2 text-xs sm:text-sm font-medium transition-all relative flex flex-col items-center gap-1.5
                                    ${activeTab === tab.id ? 'bg-slate-50 text-slate-800' : 'text-slate-400 hover:text-slate-600 hover:bg-slate-50/50'}
                                `}
                            >
                                <Icon path={tab.iconPath} size={18} className={activeTab === tab.id ? 'text-slate-700' : 'text-slate-300'} />
                                <span>{tab.label}</span>
                                <span className="bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full text-[10px]">
                                    {getCount(tab.id)}
                                </span>
                                {activeTab === tab.id && <div className="absolute bottom-0 left-0 w-full h-0.5 bg-slate-600" />}
                            </button>
                        ))}
                    </div>
                    <div className="divide-y divide-slate-50 max-h-[600px] overflow-y-auto bg-white custom-scrollbar">
                        {comments.map((item, idx) => {
                            let content = '';
                            let label = '';
                            if (activeTab === 'satisfaction') { content = item.satReason; label = `満足度: ${item.satisfaction}`; }
                            else if (activeTab === 'recommend') { content = item.recReason; label = `推奨スコア: ${item.recScore}`; }
                            else if (activeTab === 'inconvenience' && item.hasInconv) { content = item.inconvDetail || "具体的な記述なし"; label = "不便あり"; }

                            if (!content) return null;

                            return (
                                <div key={idx} className="p-5 hover:bg-slate-50 transition-colors">
                                    <div className="flex flex-wrap gap-2 items-center text-xs text-slate-400 mb-2.5">
                                        <span className="font-mono bg-slate-100 px-1.5 py-0.5 rounded text-slate-500">{item.timestamp.split(' ')[0]}</span>
                                        <span className="flex items-center gap-1"><Icon path={icons.globe} size={10} /> {item.country}</span>
                                        <span>•</span><span>{item.age}</span>
                                        {label && <span className="ml-auto font-medium text-slate-600 bg-slate-100 px-2 py-0.5 rounded">{label}</span>}
                                    </div>
                                    <p className="text-slate-700 text-sm leading-relaxed whitespace-pre-wrap">{content}</p>
                                </div>
                            );
                        })}
                        {getCount(activeTab) === 0 && (
                            <div className="p-10 text-center flex flex-col items-center text-slate-400">
                                <Icon path={icons.messageSquare} size={32} className="mb-2 opacity-20" />
                                <p className="text-sm">該当するコメントはありません</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- Main App Component ---
        const App = () => {
            const [selectedFacility, setSelectedFacility] = useState(null);
            const [data, setData] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                const fetchData = async () => {
                    try {
                        // GitHub Pages path resolution: current directory
                        const response = await fetch('./milliforinbound.csv');
                        if (!response.ok) {
                            throw new Error(`Data fetch failed: ${response.status} ${response.statusText}`);
                        }
                        
                        // Explicitly decode as UTF-8
                        const buffer = await response.arrayBuffer();
                        const decoder = new TextDecoder('utf-8');
                        let csvText = decoder.decode(buffer);
                        
                        // Remove BOM (Byte Order Mark) if present (common in Excel UTF-8 CSVs)
                        if (csvText.charCodeAt(0) === 0xFEFF) {
                            csvText = csvText.slice(1);
                        }

                        const parsedData = parseCSV(csvText);
                        setData(parsedData);
                        setIsLoading(false);
                    } catch (err) {
                        console.error("Failed to load CSV:", err);
                        setError("データの読み込みに失敗しました。ファイル(milliforinbound.csv)を確認してください。");
                        setIsLoading(false);
                    }
                };

                fetchData();
            }, []);

            // Aggregate facilities with counts
            const facilityStats = useMemo(() => {
                const stats = {};
                data.forEach(d => {
                    if (d.facility) {
                        stats[d.facility] = (stats[d.facility] || 0) + 1;
                    }
                });
                // Convert to array and sort by count descending
                return Object.entries(stats)
                    .map(([name, count]) => ({ name, count }))
                    .sort((a, b) => b.count - a.count);
            }, [data]);

            const filteredData = useMemo(() => {
                if (!selectedFacility) return [];
                return data.filter(d => d.facility === selectedFacility);
            }, [data, selectedFacility]);

            const analysis = useMemo(() => {
                if (filteredData.length === 0) return null;

                const aggregate = (field, isMulti = false) => {
                    const counts = {};
                    filteredData.forEach(d => {
                        const rawVal = d[field];
                        if (!rawVal) return;
                        if (isMulti) {
                            // Split by comma
                            rawVal.split(',').forEach(v => {
                                const val = v.trim();
                                if (val) counts[val] = (counts[val] || 0) + 1;
                            });
                        } else {
                            counts[rawVal] = (counts[rawVal] || 0) + 1;
                        }
                    });
                    return Object.entries(counts).map(([name, value]) => ({ name, value }));
                };

                const satMap = {
                    'Very satisfied': 5, 'Satisfied': 4, 'Somewhat satisfied': 3, 
                    'Somewhat dissatisfied': 2, 'Dissatisfied': 1
                };
                const avgSat = (filteredData.reduce((acc, curr) => acc + (satMap[curr.satisfaction] || 0), 0) / filteredData.length).toFixed(1);

                const promoters = filteredData.filter(d => d.recScore >= 9).length;
                const detractors = filteredData.filter(d => d.recScore <= 6).length;
                const total = filteredData.length;
                const nps = Math.round(((promoters - detractors) / total) * 100);

                return {
                    nps,
                    avgSat,
                    country: aggregate('country'),
                    age: aggregate('age'),
                    gender: aggregate('gender'),
                    companion: aggregate('companion'),
                    japanStatus: aggregate('japanStatus'),
                    visitCountJapan: aggregate('visitCountJapan'),
                    stayDays: aggregate('stayDays'),
                    purpose: aggregate('purpose'),
                    travelStyle: aggregate('travelStyle'),
                    ishikawaStatus: aggregate('ishikawaStatus'),
                    visitCountIshikawa: aggregate('visitCountIshikawa'),
                    stayNightsIshikawa: aggregate('stayNightsIshikawa'),
                    accommodation: aggregate('accommodation'),
                    destinations: aggregate('destinations', true),
                    experiences: aggregate('experiences', true),
                    events: aggregate('events'),
                    transportJapan: aggregate('transportJapan', true),
                    transportIshikawa: aggregate('transportIshikawa', true),
                    infoSource: aggregate('infoSource', true),
                    comments: filteredData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                };
            }, [filteredData]);

            // Loading
            if (isLoading) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-6 text-slate-500">
                        <Icon path={icons.loader} size={32} className="animate-spin mb-4 text-slate-400" />
                        <p>データを読み込んでいます...</p>
                    </div>
                );
            }

            // Error
            if (error) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-6 text-slate-800">
                        <div className="bg-white p-8 rounded-xl shadow-sm border border-red-100 max-w-md text-center">
                            <Icon path={icons.alertCircle} size={40} className="mx-auto mb-4 text-red-500" />
                            <h2 className="text-xl font-bold mb-2">エラーが発生しました</h2>
                            <p className="text-slate-500 text-sm">{error}</p>
                        </div>
                    </div>
                );
            }

            // Landing Page
            if (!selectedFacility) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-6 text-slate-800">
                        <div className="max-w-md w-full space-y-8">
                            <div className="text-center space-y-2">
                                <h1 className="text-4xl font-extrabold text-slate-800 tracking-tight">Milli <span className="text-slate-400 font-light">for Inbound</span></h1>
                                <p className="text-slate-500 font-medium">インバウンド観光客分析ツール</p>
                            </div>
                            <Card className="border-t-4 border-t-slate-600">
                                <h2 className="text-lg font-bold mb-6 text-center text-slate-800">分析する施設を選択</h2>
                                <div className="space-y-3 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar">
                                    {facilityStats.map((fac, idx) => (
                                        <button
                                            key={idx}
                                            onClick={() => setSelectedFacility(fac.name)}
                                            className="w-full p-4 text-left border border-slate-200 rounded-xl hover:border-slate-400 hover:bg-slate-50 hover:text-slate-800 transition-all group flex items-center justify-between bg-white shadow-sm"
                                        >
                                            <span className="font-bold">{fac.name}</span>
                                            <div className="flex items-center gap-2">
                                                <span className="text-[10px] text-slate-500 bg-slate-100 px-2 py-0.5 rounded-full font-medium">{fac.count}件</span>
                                                <Icon path={icons.arrowLeft} className="rotate-180 opacity-30 group-hover:opacity-100 transition-opacity text-slate-400" size={18} />
                                            </div>
                                        </button>
                                    ))}
                                </div>
                                {facilityStats.length === 0 && (
                                    <p className="text-center text-sm text-slate-400 mt-4">利用可能な施設データが見つかりませんでした。</p>
                                )}
                            </Card>
                        </div>
                    </div>
                );
            }

            // Dashboard
            return (
                <div className="min-h-screen font-sans text-slate-800 pb-32">
                    {/* Header */}
                    <header className="sticky top-0 z-50 bg-white/95 backdrop-blur-sm border-b border-slate-200 px-6 py-4 shadow-sm">
                        <div className="max-w-4xl mx-auto flex items-center justify-between">
                            <button onClick={() => setSelectedFacility(null)} className="p-2 -ml-2 hover:bg-slate-100 rounded-full transition-colors text-slate-500">
                                <Icon path={icons.arrowLeft} size={20} />
                            </button>
                            <div className="text-center">
                                <h1 className="text-base font-bold text-slate-800">{selectedFacility}</h1>
                                <p className="text-[10px] text-slate-400 font-medium uppercase tracking-wider">Analysis Report</p>
                            </div>
                            <div className="w-8"></div> 
                        </div>
                    </header>

                    <main className="max-w-4xl mx-auto px-4 py-8 space-y-12">
                        
                        {/* KPI Row */}
                        <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <Card className="flex flex-col justify-between border-slate-200">
                                <div className="flex justify-between items-start">
                                    <p className="text-xs text-slate-500 font-medium uppercase tracking-wider">総回答数</p>
                                    <Icon path={icons.users} size={16} className="text-slate-300" />
                                </div>
                                <p className="text-5xl font-light text-slate-800 mt-2 tracking-tighter">
                                    {filteredData.length}<span className="text-sm font-normal text-slate-400 ml-1 tracking-normal">件</span>
                                </p>
                            </Card>
                            
                            <Card className="flex flex-col justify-between border-slate-200">
                                <div className="flex justify-between items-start">
                                    <p className="text-xs text-slate-500 font-medium uppercase tracking-wider">満足度 (平均)</p>
                                    <Icon path={icons.star} size={16} className="text-slate-300" />
                                </div>
                                <div className="flex items-end gap-2 mt-2">
                                    <p className="text-5xl font-light text-slate-800 tracking-tighter">{analysis.avgSat}</p>
                                    <div className="flex gap-0.5 mb-2.5">
                                        {[1,2,3,4,5].map(star => (
                                            <Icon 
                                                key={star} 
                                                path={icons.star} 
                                                size={10} 
                                                className={star <= Math.round(analysis.avgSat) ? "text-slate-500 fill-slate-500" : "text-slate-200"} 
                                            />
                                        ))}
                                    </div>
                                </div>
                            </Card>
                            
                            <div className="col-span-2 md:col-span-1">
                                <NPSMeter nps={analysis.nps} />
                            </div>
                        </div>

                        {/* Section 1: Attributes */}
                        <section>
                            <SectionHeader title="属性" iconPath={icons.users} />
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <Card>
                                    <RankingCard title="国籍・地域" data={analysis.country} />
                                </Card>
                                <Card>
                                    <RankingCard title="年代" data={analysis.age} />
                                    <div className="my-6 border-t border-slate-100" />
                                    <RankingCard title="性別" data={analysis.gender} />
                                    <div className="my-6 border-t border-slate-100" />
                                    <RankingCard title="同行者" data={analysis.companion} />
                                </Card>
                            </div>
                        </section>

                        {/* Section 2: Japan Trip Context */}
                        <section>
                            <SectionHeader title="日本旅行について" iconPath={icons.flag} />
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <Card>
                                    <RankingCard title="現在の状況" data={analysis.japanStatus} />
                                    <div className="my-6 border-t border-slate-100" />
                                    <RankingCard title="訪日回数" data={analysis.visitCountJapan} />
                                    <div className="my-6 border-t border-slate-100" />
                                    <RankingCard title="滞在日数" data={analysis.stayDays} />
                                </Card>
                                <Card>
                                    <RankingCard title="主な目的" data={analysis.purpose} />
                                    <div className="my-6 border-t border-slate-100" />
                                    <RankingCard title="旅行スタイル" data={analysis.travelStyle} />
                                    <div className="my-6 border-t border-slate-100" />
                                    <RankingCard title="出発前の情報源" data={analysis.infoSource} />
                                </Card>
                            </div>
                        </section>

                        {/* Section 3: Ishikawa Trip Context */}
                        <section>
                            <SectionHeader title="石川旅行について" iconPath={icons.mapPin} />
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <Card>
                                    <RankingCard title="石川での状況" data={analysis.ishikawaStatus} />
                                    <div className="my-6 border-t border-slate-100" />
                                    <RankingCard title="訪問回数" data={analysis.visitCountIshikawa} />
                                </Card>
                                <Card>
                                    <RankingCard title="宿泊日数" data={analysis.stayNightsIshikawa} />
                                    <div className="my-6 border-t border-slate-100" />
                                    <RankingCard title="宿泊先タイプ" data={analysis.accommodation} />
                                </Card>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                                <Card>
                                    <RankingCard title="訪問先・予定地" data={analysis.destinations} />
                                </Card>
                                <Card>
                                    <RankingCard title="体験内容" data={analysis.experiences} />
                                    <div className="my-6 border-t border-slate-100" />
                                    <RankingCard title="参加イベント・祭り" data={analysis.events} />
                                </Card>
                            </div>
                        </section>

                        {/* Section 4: Transport & Money */}
                        <section>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 items-stretch">
                                <div>
                                    <SectionHeader title="交通手段" iconPath={icons.train} />
                                    <Card className="h-full">
                                        <RankingCard title="日本での移動手段" data={analysis.transportJapan} />
                                        <div className="my-8 border-t border-slate-100" />
                                        <RankingCard title="石川での移動手段" data={analysis.transportIshikawa} />
                                    </Card>
                                </div>
                                <div>
                                    <SectionHeader title="消費" iconPath={icons.wallet} />
                                    <Histogram data={filteredData} />
                                </div>
                            </div>
                        </section>

                        {/* Section 5: Feedback */}
                        <section className="pt-8">
                            <SectionHeader title="お客様の声" iconPath={icons.messageSquare} />
                            <FeedbackTabs comments={analysis.comments} />
                        </section>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
